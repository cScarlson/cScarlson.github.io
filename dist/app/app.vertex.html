
<!-- @name: app -->
<script type="module" lang="js" defer>
    import V, { LIFECYCLE_EVENTS } from './vertices/core.js';
    
    const { log } = console;
    const { onmount, onrender } = LIFECYCLE_EVENTS;
    
    V('app')(function App({ self, module, metadata }) {
        const thus = this;
        const $content = new Map();
        
        function init() {
            const { nextElementSibling: root } = self;
            const content = root.querySelector('.app.content');
            const input = content.querySelector('#input');
            const CONTENT = fetch('./api/v1/content', { headers: { 'Content-Type': 'application/json' } })
                .then( r => r.json() )
                ;
            
            log(`#####`, content, input)
            this.content = content;
            module.addEventListener('menu:state', this, true);
            module.addEventListener('input', this, true);
            window.addEventListener('hashchange', this, false);
            
            return this;
        }
        
        function handleContent(collection) {
            collection.reduce(set, this.$content);
            
            function set($, data) {
                const { name } = data;
                V.set(`content:${name}`, data);
                return $.set(name, data);
            }
        }
        
        function handleEvent(e) {
            const { type } = e;
            const handler = {
                'menu:state': handleMenuState,
                'hashchange': handleHashchange,
                'input': (e) => e.target.matches('#input') ? log(`on${type}`, this.test = e.target.value) : '',
            }[ type ];
            
            if (handler) handler.call(this, e);
        }
        
        function handleMenuState(e) {
            const { content } = this;
            const { classList } = content;
            const { detail } = e;
            const { opened } = detail;
            const status = 'defocused';
            
            if (opened) classList.add(status);
            else classList.remove(status);
        }
        
        function handleHashchange (e) {
            setTimeout( () => location.hash = location.hash.replace('/noop', ''), 1000 );
        }
        
        const E = { id: 994, title: 'E' };
        
        // export precepts
        this.test = 'unidirectional databinding';
        this.items = [ { id: 990, title: 'A' }, { id: 991, title: 'B' }, { id: 992, title: 'C' } ];
        this.$content = $content;
        this[onmount] = init;
        this.handleEvent = handleEvent;
        log(`@app`, this.matches('[type="app"]'));
        setTimeout( x => this.items.push({ id: 993, title: 'D' }), 2000 );
        setTimeout( x => this.items = [ ...this.items, E ], 3000 );
        setTimeout( x => this.items[4].title = 'GGG', 4000 );
        setTimeout( x => this.test = `${this.test}!!!`, 5000 );
        
        return this;
    });
</script>

<div --view class="app root">
    <header class="app header">
        <module type="menu" slot="menu" [menuTest]="test">
            <div slot="menu">
                <div>
                    <a href="#/noop/">Home</a>
                </div>
                <div>
                    <a href="#/noop/app/about">About</a>
                </div>
                <div>
                    <a href="#/noop/app/resume">Resume</a>
                </div>
                <div>
                    <a href="#/noop/app/cv">Curriculum Vitae</a>
                </div>
                <div>
                    <a href="#/noop/app/footer">More</a>
                </div>
            </div>
        </module>
    </header>
    <main class="app content">
        <div class="content canvas">
            <module id="/" type="page">
                <span slot="title">Home</span>
                <div slot="content">
                    <h1>${test}</h1>
                    <input id="input" .="value:test">
                    <div id="theDiv" +="item of items">
                        <input id="input" .="value:test" .="dataset.length:items.length" .="dataset.test:item.title">
                    </div>
                    <input id="input" .="value:test" +="item of items" .="dataset.length:items.length" .="dataset.test:item.title">
                    <div .="innerHTML:test">...</div>
                    <div>${items.length}</div>
                    <div .="innerHTML:items.length">...</div>
                    <div +="item of items" .="innerHTML:item.title">...</div>
                </div>
            </module>
        </div>
    </main>
    <footer class="app footer">
        <module id="/app/footer" type="page" src="./app/subsystem/page.vertex.html">
            <span slot="title">Footer</span>
            <div slot="content"></div>
        </module>
    </footer>
</div>

<!-- 
    Look into leveraging interpolable templates -- especially for styling...
    
    <module type="any" src="...">
        <script type="module"></script>
        <div class="any element" template="anyTemplate">`${interpolated}`</div>
        -- THEN --
        <template id="anyTemplate" type="html">
            <h1 class="element title">`${pageTitle}`</h1>
        </template>
        -- AND --
        <template id="cssTemplate" type="css">
            .any.element .element.title {
                display: `${css.display}`;
                color: `${css.color}`;
            }
        </template>
        -- OR --
        <script type="text/css">
            .any.element .element.title {
                display: `${css.display}`;
                color: `${css.color}`;
            }
        </script>
        -- THEN --
        <style>`${styles}`</style>
    </module>
    --------------------------------------------------------------------------------------------------------------------------------
    V.decorate([ ..., Sandbox ]);
    V.reduce({
        ['content:home'](state, { type, payload }) { return { ...state, [type]: payload } }
    });
    V.dock({ 'some:type': './**/*.html' });
    --------------------------------------------------------------------------------------------------------------------------------
    ATTRIBUTES (static/primitive, not dynamic/referrential)
    <module type="any" src="..." some-attr="static"></module>
    Vertices should provide Element.prototype.attributes as arguments to components (registered faculties).
    --------------------------------------------------------------------------------------------------------------------------------
    SLOTS: Should Vertices provide internal <slot>s as arguments to components (registered faculties)?
    --------------------------------------------------------------------------------------------------------------------------------
    vertices.load() can look at the id of the <module> to auto-bootstrap the registered JS class, which is declared within the markup.
    <module type="example" src="./app/example.vertex.html">
        <script type="module">
            import { V } from './vertices/core.js';
            
            V(class ExampleComponent {
                static type = 'example';
                
                constructor(target: Element|Sandbox) {
                    const { parentElement: module, nextSibling: element } = target;  // natural convention for handle on cardinal element.
                    const { nextSibling: styles } = element;
                    
                    module.addEventListener('vertex:{lifecycle-event}', ...);
                    
                }
                
            });
        </script>
        <div class="app example">
            <div v="directive1,directive2,...,directiveN"></div>
        </div>
        <style>...</style>
    </module>
 -->

<style lang="css">
    @import url("./vertices/revert.css");
    @import url("./vertices/styles.css");
    
    module[id]:target {
        box-shadow: 0px 0px 16px -4px white;
    }
    module[id]:target .page.title {
        color: darkcyan;
    }
    
    .app.root {
        background:
            linear-gradient(transparent, lightsalmon),
            radial-gradient(circle at 40% 200px, #f09819 80px, transparent 280px),
            radial-gradient(circle at 36% 500px, #1845ad 80px, transparent 280px),
            radial-gradient(circle at 64% 360px, #ff512f 80px, transparent 280px)
            ;
        background-size: 100%;
        background-attachment: fixed;
        background-repeat: no-repeat;
        background-origin: border-box;
        position: relative;
        height: 100%;
        border-width: 0px;
    }
    
    .app.root .app.header {
        position: sticky;
        top: 0;
        z-index: 999;
    }
    
    .app.root .app.content {
        width: 100%;
        border-style: solid;
        border-width: 3px;
        border-color: rgba(255, 255, 255, 0);
        border-radius: 0;
        transform: scale(1);
        transition: transform 1s, border 1s, border-radius 1s, top 1s;
        transform-origin: top;
    }
    .app.root .app.content.defocused {
        position: sticky;
        top: calc(var(--menu-height) + 12px);
        height: 100vh;
        margin-top: 12px;
        border-color: rgba(255, 255, 255, 1);
        border-radius: 100px;
        transform: scale(0.2);
        transition: transform 1s, border 1s, border-radius 1s, top 1s;
        overflow: hidden;
        transform-origin: top;
        z-index: 0;
    }
    
    .app.root .app.content .content.canvas {
        width: 100%;
        max-width: 1080px;
        margin-left: 50%;
        border: solid 0px transparent;
        transform: translateX(-50%);
        transition: transform 1s;
        /* background-color: rgba(255, 255, 255, 0.15); */
    }
    
    .app.root .app.footer {
        position: sticky;
        top: 0;
        margin: 0;
        padding: 0;
        background-color: rgb(119, 136, 153, 0.75);
        z-index: 1;
    }
    
    .app.root .app.footer [type="page"] .app.page {
        margin-bottom: 0;
        background-color: transparent;
    }
</style>
